<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>智慧商贸
新增组装拆卸    </title>
    <script src="/Content/jquery-easyui/jquery-1.7.2.min.js?v2.9.5" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="/Content/themes/default/css/style.css?v2.9.5" />
    <link rel="stylesheet" type="text/css" href="/Content/jquery-easyui/themes/default/easyui.css?v2.9.5" />
    <link rel="stylesheet" type="text/css" href="/Content/jquery-easyui/themes/icon.css?v2.9.5" />
    <script src="/Scripts/jquery.validate-1.11.1.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/jquery.validate.unobtrusive.min.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/modernizr-1.7.min.js?v2.9.5" type="text/javascript"></script>
    <script src="/Content/My97DatePicker/WdatePicker.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/PropertyManager.js?v2.9.5" type="text/javascript"></script> 
    <script src="/Scripts/SelectProducts.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/GetState.js?v2.9.5" type="text/javascript"></script>
    <script src="/Content/jquery-easyui/jquery.easyui.min.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/PERM.js?2013?v2.9.5" type="text/javascript"></script>
    <script type="text/javascript" src="/Scripts/jquery.unobtrusive-ajax.min.js?v2.9.5"></script>
    <script src="/Scripts/MVCPage.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/jquery_validator_message_cn.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/PageLoading.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/ChinesePY.js?v2.9.5" type="text/javascript"></script> 
    <!--PNG透明-->
    <!--[if lte IE 6]>
    <script src="/Scripts/DD_belatedPNG_0.0.8a.js" type="text/javascript"></script>
        <script type="text/javascript">
            DD_belatedPNG.fix('*');
        </script>
    <![endif]-->
</head>
<body>
    <div id="loading"></div>
    <table style="min-width: 882px;" width="100%" border="0" height="610" cellspacing="0" cellpadding="0">
        <tr>
            <td valign="top" bgcolor="#e6e6e8" class="main">
                <script src="/Scripts/jquery.autocomplete.min.js" type="text/javascript"></script>
<style type="text/css">
    .tipDiag {
        position: absolute;
        padding: 3px;
        font-size: 12px;
        border: 1px solid #F00;
        background: #FFF8CB url(../../Content/themes/redhot/images/warning.png) no-repeat 3px 3px;
        color: #000;
        display: none;
        padding-left: 16px;
    }

    .htd {
        background-color: #fdf7f7;
        text-align: center;
    }
</style>
<form action="/Assembly/Save" method="post"><input data-val="true" data-val-required="The AssemblyId field is required." id="AssemblyId" name="AssemblyId" type="hidden" value="00000000-0000-0000-0000-000000000000" /><input data-val="true" data-val-required="The IsToList field is required." id="IsToList" name="IsToList" type="hidden" value="False" /><input data-val="true" data-val-number="字段 IsWriteBack 必须是一个数字。" data-val-required="The IsWriteBack field is required." id="IsWriteBack" name="IsWriteBack" type="hidden" value="0" /><input id="IsOpenProductSN" name="IsOpenProductSN" type="hidden" value="0" />    <table width="100%" border="0" cellspacing="0" cellpadding="0" height="500">
        <tr>
            <td valign="top">
                <div class="buttonArea">
                    <div class="left">
                        <a class="button blueButton" onclick="SaveData(false);">保存并新增</a><a class="button" onclick="SaveData(true);">保存</a>
                    </div>
                    <!-- left -->
                    <div class="right">
                        <a class="button greenButton" onclick="parent.childAddTab('组装拆卸历史','/Assembly/List','慧管货')">历史单据</a>
                    </div>
                    <!-- right -->
                </div>
                <!-- buttonArea -->
                <div class="clear height10"></div>
                <div class="shadowBoxWhite receipts">
                    <table width="100%" border="0" cellspacing="0" cellpadding="5" class="title">
                        <tr>
                            <td width="30%" height="50">&nbsp;</td>
                            <td width="40%" align="center" valign="top" class="text">组装拆卸单</td>
                            <td width="30%" align="right" valign="bottom" class="font999" style="padding-bottom: 20px;">单据编号：<input class="codeEdit" id="AssemblyCode" name="AssemblyCode" onchange="calAssemblyNo()" type="text" value="ZZCX20140215003" /></td>
                        </tr>
                    </table>
                    <div class="baseData">
                        <div class="fl">
                            <div class="fl">
                                <span class="font16">原商品清单</span>
                                &nbsp;&nbsp;
                                <span>出库仓库：<select id="OutWarehouseId" name="OutWarehouseId" style="width:120px"><option selected="selected" value="711a19d7-052c-46c0-9e21-e614aafc3028">默认仓库</option>
</select></span>
                            </div>
                        </div>
                        <div class="fr">
                            <table>
                                <tr>
                                    <td>经手人</td>
                                    <td><select class="inputSelect" data-val="true" data-val-required="The AssemblyUserId field is required." id="AssemblyUserId" name="AssemblyUserId"><option selected="selected" value="18cb32bc-f5dd-4704-870b-26bbad60006e">管理员</option>
</select></td>
                                    <td>&nbsp;&nbsp;业务日期</td>
                                    <td>
                                <input id="TheLstBalDate" name="TheLstBalDate" type="hidden" value="1900-01-01" />
                                <input class="inputText" id="AssemblyDate" name="AssemblyDate" onClick="WdatePicker({minDate:&#39;#F{$dp.$D(\&#39;TheLstBalDate\&#39;)}&#39;})" readonly="true" size="12" type="text" value="2014-02-15" /></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <!-- deliver -->
                    <div class="clear height10"></div>
                    <div class="tableDiv">
                        <table width="100%" border="0" cellspacing="1" cellpadding="5" id="tabProducts">
                            <tr>
                                <th width="60" height="60" align="center" valign="middle">序号</th>
                                <th align="left" valign="middle">商品名称/规格</th>
                                <th width="150" align="center" valign="middle">商品编号</th>
                                <th width="60" align="center" valign="middle">单价(元)</th>
                                <th width="65" align="center" valign="middle">数量</th>
                                <th width="50" align="center" valign="middle">单位</th>
                                <th width="80" align="center" valign="middle">
                                    <p>金额(元)</p>
                                </th>
                                <th width="80" align="center" valign="middle">备注</th>
                            </tr>
                            <tr id="trTmp" style="display: none;" onmousemove="$(this).find('.choseGoods').show()" onmouseout="$(this).find('.choseGoods').hide()">
                                <td align="center" valign="middle" bgcolor="#FFFFFF">
                                    <span id="orderdiv" class="num"></span>
                                    <span class="actionArea"><a href="javascript:;" class="plusLite" onclick="addRow(this,false);InitOrder();"></a><a href="javascript:;" class="delLite" onclick="deleteRow(this,false);"></a></span></td>
                                <td align="center" valign="middle" bgcolor="#FFFFFF">
                                    <table width="100%" cellpadding="0" cellspacing="0" border="0" class="chose">
                                        <tr>
                                            <td>
                                                <input style="text-align: left;" type="text" class="receiptsInputText" autocomplete="off" name="showProductName" id="OutProductName" /></td>
                                            <td width="50" align="right"><a style="display: none;" class="choseGoods" onclick="SelectWareProductByBusi(this.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode,'Sale',$('#OutWarehouseId').find('option:selected').val(),$('#IsOpenProductSN').val())">选择</a></td>
                                        </tr>
                                    </table>
                                </td>
                                <td align="center" valign="middle" bgcolor="#FFFFFF">
                                    <input type="hidden" name="BomProductId" />
                                    <input type="hidden" name="BomIsDecimal" value="1" />
                                    <input type="hidden" name="BomUnitCode" />
                                    <input type="text" class="receiptsInputText" autocomplete="off" name="showProductCode" /></td>
                                <td align="center" valign="middle" bgcolor="#FFFFFF">
                                    <input type="text" class="receiptsInputText" style="width: 50px" name="BomPrice" onchange="calAmt(this);" /></td>
                                <td align="center" valign="middle" bgcolor="#FFFFFF">
                                    <input type="text" class="receiptsInputText" style="width: 40px" name="BomCount" onchange="calAmt(this);" />
                                    <input type="hidden" name="hidSerialId" />
                                    <a href="javascript:;" name="aSingleSN" style="display: none;" onclick="SingleSelectSerialNo($(this).parent().parent().find('input[name=\'BomProductId\']').val(),$(this).parent().parent().find('input[name=\'hidSerialId\']').attr('id').replace('sn_',''),$('#OutWarehouseId').find('option:selected').val(), 'Sale');" class="sn"></a>
                                </td>
                                <td align="center" valign="middle" bgcolor="#FFFFFF">
                                    <input type="text" class="receiptsInputText" style="width: 40px" name="ShowUnitName" />
                                <td align="center" valign="middle" bgcolor="#FFFFFF">
                                    <input type="text" class="receiptsInputText" style="width: 70px" name="BomAmount" onchange="calPrice(this)" /></td>
                                <td align="center" valign="middle" bgcolor="#FFFFFF">
                                    <input type="text" class="receiptsInputText" style="width: 70px" name="BomRemark" /></td>
                            </tr>

                        </table>
                    </div>
                    <div class="clear height10"></div>
                    <div class="baseData">
                        <div class="fl">
                            <div class="fl">
                                <span class="font16">新商品清单</span>
                                &nbsp;&nbsp;
                                 <span>入库仓库：<select id="InWarehouseId" name="InWarehouseId" style="width:120px"><option selected="selected" value="711a19d7-052c-46c0-9e21-e614aafc3028">默认仓库</option>
</select></span>
                            </div>
                        </div>
                    </div>
                    <div class="clear height10"></div>
                    <div class="tableDiv">
                        <table width="100%" border="0" cellspacing="1" cellpadding="5" id="tabNewProducts">
                            <tr>
                                <th width="60" height="60" align="center" valign="middle">序号</th>
                                <th align="left" valign="middle">商品名称/规格</th>
                                <th width="150" align="center" valign="middle">商品编号</th>
                                <th width="60" align="center" valign="middle">单价(元)</th>
                                <th width="65" align="center" valign="middle">数量</th>
                                <th width="50" align="center" valign="middle">单位</th>
                                <th width="80" align="center" valign="middle">
                                    <p>金额(元)</p>
                                </th>
                                <th width="80" align="center" valign="middle">备注</th>
                            </tr>
                            <tr id="trNewTmp" style="display: none;" onmousemove="$(this).find('.choseGoods').show()" onmouseout="$(this).find('.choseGoods').hide()">
                                <td align="center" valign="middle" bgcolor="#FFFFFF">
                                    <span id="orderdiv" class="num"></span>
                                    <span class="actionArea"><a href="javascript:;" class="plusLite" onclick="addRow(this,true);InitOrder();"></a><a href="javascript:;" class="delLite" onclick="deleteRow(this,true);"></a></span></td>
                                <td align="center" valign="middle" bgcolor="#FFFFFF">
                                    <table width="100%" cellpadding="0" cellspacing="0" border="0" class="chose">
                                        <tr>
                                            <td>
                                                <input style="text-align: left;" type="text" class="receiptsInputText" autocomplete="off" name="showProductName" id="InProductName" /></td>
                                            <td width="50" align="right"><a style="display: none;" class="choseGoods" onclick="SelectWareProductByBusi(this.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode,'Buy',$('#InWarehouseId').find('option:selected').val(),$('#IsOpenProductSN').val())">选择</a></td>
                                        </tr>
                                    </table>
                                </td>
                                <td align="center" valign="middle" bgcolor="#FFFFFF">
                                    <input type="hidden" name="NewProProductId" />
                                    <input type="hidden" name="NewProUnitCode" />
                                    <input type="hidden" name="NewProIsDecimal" value="1" />
                                    <input type="hidden" name="hidRowId" />
                                    <input type="hidden" name="hidSerialNo" onchange="SetWarehouseStock(this)" />
                                    <input type="hidden" name="hidSerialRemarks" />
                                    <input type="text" class="receiptsInputText" autocomplete="off" name="showProductCode" /></td>
                                <td align="center" valign="middle" bgcolor="#FFFFFF">
                                    <input type="text" class="receiptsInputText" style="width: 50px" name="NewProPrice" onchange="calAmt(this);" /></td>
                                <td align="center" valign="middle" bgcolor="#FFFFFF">
                                    <input type="text" class="receiptsInputText" style="width: 40px" name="NewProCount" onchange="calAmt(this);" />
                                    <a href="javascript:;" name="aSingleSN" style="display: none;" onclick="openSn(this.parentNode.parentNode)" class="sn"></a>
                                </td>
                                <td align="center" valign="middle" bgcolor="#FFFFFF">
                                    <input type="text" class="receiptsInputText" style="width: 40px" name="ShowUnitName" />
                                <td align="center" valign="middle" bgcolor="#FFFFFF">
                                    <input type="text" class="receiptsInputText" style="width: 70px" name="NewProAmount" onchange="calPrice(this)" /></td>
                                <td align="center" valign="middle" bgcolor="#FFFFFF">
                                    <input type="text" class="receiptsInputText" style="width: 70px" name="NewProRemark" /></td>
                            </tr>
                            <tr id="tr_remark" empty="false">
                                <td width="60" align="center" valign="middle" bgcolor="#FFFFFF">备注</td>
                                <td align="left" valign="middle" bgcolor="#FFFFFF" colspan="7">
                                    <input style="text-align:left" type="text" class="receiptsInputText" name="Remark" value=""/></td>
                            </tr>
                        </table>
                    </div>
                    <!-- tableDiv -->
                    <div class="bottomButtonArea">
                        <div class="left font999">制单人：管理员&nbsp;&nbsp;&nbsp;&nbsp;制单时间：2014-02-15 12:25:59</div>
                        <div class="right">
                            <a class="button" onclick="closethistab('新增组装拆卸');">取消</a>
                            <a class="button" onclick="SaveData(true);">保存</a>
                            <a class="button blueButton" onclick="SaveData(false);">保存并新增</a>
                        </div>
                    </div>
                    <!-- buttonArea -->
                </div>
                <!-- receipts -->
            </td>
        </tr>
    </table>     
</form><script type="text/javascript">

    jQuery.fn.isChildOf = function (b) {
        return (this.parents(b).length > 0);
    };

    $(function () {
        var isToList = requestUrlPara("IsToList");
        if (isToList == 'True') {
            parent.childAddTab('组装拆卸历史', '/Assembly/List?IsToList=' + isToList, '慧管货');
        }
        //验证权限
        var isAudit = checkPermByCode('PERM_ADD');
        if (!isAudit) {
            Dialog.alert("非常抱歉，您没有权限访问该页面!", function () {
                window.location.href = "./List";
            });
            return;
        }
        //验证帐套状态
        var sobState = GetSOBState(false);
        if (sobState == "2") {
            Dialog.alert("该账套已封账，不能操作！", function () {
                window.location.href = "./List";
            });
            return;
        } else {
            if (sobState == "3") {
                unLockState();
                return;
            } else if (sobState != "1") {
                Dialog.alert("当前帐套不是开账状态！请先开账！", function () {
                    window.location.href = "./List";
                })
                return;
            }
            addRow(null, false);
            addRow(null, false);
            addRow(null, false);
            addRow(null, false);
            addRow(null, false);

            addRow(null, true);
            addRow(null, true);
            addRow(null, true);
            addRow(null, true);
            addRow(null, true);
        }

        InitOrder();
    });

    function fillTr(tr, obj) {
        var vform = obj["Form"];
        var serialSn = "0";
        if (vform && vform != null && vform != "") {
            vform = "/" + vform
        } else {
            vform = "";
        }

        $(tr).children('td').eq(1).find('input[name="showProductName"]').val(obj["Name"] + vform);
        $(tr).children('td').eq(1).find('input[name="showProductName"]').attr("readonly", "readonly");
        $(tr).children('td').eq(1).find('input[name="showProductName"]').attr("unselectable", "on");
        $(tr).children('td').eq(2).find('input[name="showProductCode"]').val(obj["Code"]);
        $(tr).children('td').eq(2).find('input[name="showProductCode"]').attr("readonly", "readonly");
        $(tr).children('td').eq(2).find('input[name="showProductCode"]').attr("unselectable", "on");
        $(tr).children('td').eq(2).find('input[name$="ProductId"]').val(obj["ID"]);
        if (obj["RowId"] != null) {
            $(tr).find('input[name="hidSerialId"]').attr("id", "sn_" + obj["RowId"]);
            $(tr).children('td').eq(2).find('input[name="hidRowId"]').val(obj["RowId"]);
            $(tr).children('td').eq(2).find('input[name="hidSerialNo"]').attr("id", "sno" + obj["RowId"]);
            $(tr).children('td').eq(2).find('input[name="hidSerialRemarks"]').attr("id", "snr" + obj["RowId"]);
        }
        $(tr).children('td').eq(2).find('input[name$="UnitCode"]').val(obj["UnitCode"]);
        $(tr).children('td').eq(2).find('input[name$="IsDecimal"]').val(obj["IsDecimal"]);
        $(tr).children('td').eq(3).find('input[name$="Price"]').val(obj["CostPrice"]);
        if (serialSn == "1") {
            if (obj["SNManage"] != "0") {
                $(tr).children('td').eq(4).find('a[name="aSingleSN"]').show();
            } else {
                $(tr).children('td').eq(4).find('a[name="aSingleSN"]').hide();
            }
            if (obj["SNManage"] == "1") {
                $(tr).children('td').eq(4).find('input[name$="Count"]').attr("readonly", "readonly");
                $(tr).children('td').eq(4).find('input[name$="Count"]').attr("unselectable", "on");
                $(tr).children('td').eq(4).find('input[name$="Count"]').val(0).change();
            }
            else {
                $(tr).children('td').eq(4).find('input[name$="Count"]').removeAttr("readonly");
                $(tr).children('td').eq(4).find('input[name$="Count"]').removeAttr("unselectable");
                $(tr).children('td').eq(4).find('input[name$="Count"]').val(1).change();
            }
        }
        else {
            $(tr).children('td').eq(4).find('input[name$="Count"]').val(1).change();
        }
        //$(tr).children('td').eq(4).find('input[name$="Count"]').val(1).change();
        $(tr).children('td').eq(5).find('input[name="ShowUnitName"]').val(obj["Unit"]);
        $(tr).children('td').eq(5).find('input[name="ShowUnitName"]').attr("readonly", "readonly");
        $(tr).children('td').eq(5).find('input[name="ShowUnitName"]').attr("unselectable", "on");
        $(tr).children('td').eq(7).find('input[name$="Remark"]').val(obj["Remark"]);
        $(tr).attr("empty", "false");
    }
    // 选择商品点击OK处理填充数据
    function SelectProductOK(tempJson, obj) {

        var isNew = $(obj).isChildOf('#tabNewProducts');
        var tab = isNew == false ? $("#tabProducts") : $("#tabNewProducts");
        var forCloneTr = isNew == false ? $("#trTmp") : $("#trNewTmp");
        var emptyTrSelector = isNew == false ? "#tabProducts tr[empty='true']" : "#tabNewProducts tr[empty='true']";
        if (tempJson && tempJson != null && tempJson.length > 0) {
            var cnt = 0;
            fillTr(obj, tempJson[cnt++]);
            var emptyTrSize = $(emptyTrSelector).length;
            var remainTrSize = tempJson.length - emptyTrSize - 1;
            if (remainTrSize > 0) {
                for (var i = 0; i < remainTrSize; i++) {
                    var trTmp = $(forCloneTr).clone();
                    $(trTmp).attr("id", "");
                    $(trTmp).attr("empty", "true");
                    $(trTmp).show();
                    if (isNew) {
                        $(tab).find("#tr_remark").before($(trTmp))
                    } else {
                        $(tab).append($(trTmp));
                    }
                }
            }

            rows = $(emptyTrSelector);
            $(rows).each(function () {
                if (cnt < tempJson.length)
                    fillTr(this, tempJson[cnt++]);
            });
        }

        //if ($(emptyTrSelector).length == 0) {
        //    addRow(null, isNew);
        //}

        InitOrder();
    }

    //添加行
    function addRow(obj, isNew) {
        var v_tr = isNew == false ? $("#trTmp") : $("#trNewTmp");
        var trTmp = $(v_tr).clone();
        var tempRow = v_tr;
        var temRowIndex = 0;
        trTmp.attr("id", "");
        trTmp.attr("empty", "true");
        trTmp.show();
        if (obj == null) {
            trTmp.insertBefore($(v_tr));
            obj = trTmp;
            obj.rowIndex = tempRow.rowIndex - 1;
        }
        else {
            trTmp.insertAfter(obj.parentNode.parentNode.parentNode);
            temRowIndex = obj.parentNode.parentNode.parentNode.rowIndex + 1;
            obj = trTmp;
            obj.rowIndex = temRowIndex;
        }


        var OutautoCompleteTextbox = trTmp.find("input:text[id='OutProductName']");
        if (!!OutautoCompleteTextbox) {
            //智能提示
            var productheader = { ProductCode: "商品编号", ProductName: "商品名称", Barcode: "条形码" };
            OutautoCompleteTextbox.each(function () {
                $(this).autoComplete({
                    header: productheader,
                    url: "/shared/queryproduct?WarehouseId=" + $('#OutWarehouseId').find('option:selected').val(),
                    width: 400,
                    selected: function (o) {
                        var jsonn = [];
                        var value = {
                            "ID": o.ProductId,
                            "Code": o.ProductCode,
                            "Name": o.ProductName,
                            "Form": o.From,
                            "Class": o.Class,
                            "Unit": o.Unit,
                            "Store": o.Store,
                            "CostPrice": o.CostPrice,
                            "SalePrice": o.SalePrice,
                            "UnitCode": o.UnitCode,
                            "IsDecimal": o.IsDecimal,
                            "LowSalePrice": o.LowSalePrice,
                            "HigSalePrice": o.HigSalePrice,
                            "SNManage": o.SNManage,
                            "RowId": guidGenerator()
                        };
                        jsonn.push(value);
                        SelectProductOK(jsonn, obj);
                        if ($(obj).next().find("span").html() == '') {
                            addRow(null, false); InitOrder();
                        }
                        $(obj).next().find("input[name='showProductName']").focus();
                        //打开序列号管理
                        if (jsonn[0]["SNManage"] == "1") {
                            SingleSelectSerialNo($(obj).find('input[name=\'BomProductId\']').val(), $(obj).find('input[name=\'hidSerialId\']').attr('id').replace('sn_', ''), $('#OutWarehouseId').find('option:selected').val(), 'Sale');
                        }
                    }
                });
            });
        }
        var InautoCompleteTextbox = trTmp.find("input:text[id='InProductName']");
        if (!!InautoCompleteTextbox) {
            //智能提示
            var productheader = { ProductCode: "商品编号", ProductName: "商品名称", Barcode: "条形码" };
            InautoCompleteTextbox.each(function () {
                $(this).autoComplete({
                    header: productheader,
                    url: "/shared/queryproduct?WarehouseId=" + $('#InWarehouseId').find('option:selected').val(),
                    width: 400,
                    selected: function (o) {
                        var jsonn = [];
                        var value = {
                            "ID": o.ProductId,
                            "Code": o.ProductCode,
                            "Name": o.ProductName,
                            "Form": o.From,
                            "Class": o.Class,
                            "Unit": o.Unit,
                            "Store": o.Store,
                            "CostPrice": o.CostPrice,
                            "SalePrice": o.SalePrice,
                            "UnitCode": o.UnitCode,
                            "IsDecimal": o.IsDecimal,
                            "LowSalePrice": o.LowSalePrice,
                            "HigSalePrice": o.HigSalePrice,
                            "SNManage": o.SNManage,
                            "RowId": guidGenerator()
                        };
                        jsonn.push(value);
                        SelectProductOK(jsonn, obj);
                        if ($(obj).next().find("span").html() == '') {
                            addRow(null, true); InitOrder();
                        }
                        $(obj).next().find("input[name='showProductName']").focus();
                        //打开序列号管理
                        if (jsonn[0]["SNManage"] == "1") {
                            SingleSelectSerialNo($(obj).find('input[name=\'NewProProductId\']').val(), $(obj).find('input[name=\'hidSerialId\']').attr('id').replace('sn_', ''), $('#InWarehouseId').find('option:selected').val(), 'Buy');
                        }
                    }
                });
            });
        }
    }

    //删除行
    function deleteRow(obj, isNew) {
        obj.parentNode.parentNode.parentNode.parentNode.removeChild(obj.parentNode.parentNode.parentNode);
        var vobj = isNew == false ? $("#tabProducts tr[id!='trTmp']") : $("#tabNewProducts tr[id!='trNewTmp']")
        if ($(vobj).find("input:text[autocomplete='off']").length <= 1) {
            addRow(null, isNew);
        }
        $(vobj).find("input:text[autocomplete='off']").first().focus();
        InitOrder();
    }

    //初始化序号
    function InitOrder() {
        var rows = $("#tabProducts tr");
        var orders = 1;
        for (var i = 0; i < rows.length; i++) {
            if ($(rows[i]).children('td').eq(2).find('input[type="hidden"]').length >= 1 && $(rows[i]).attr("id") != "trTmp") {
                $(rows[i]).children('td').eq(0).children('#orderdiv').text(orders);
                orders++;
            }
        }

        rows = $("#tabNewProducts tr");
        orders = 1;
        for (var i = 0; i < rows.length; i++) {
            if ($(rows[i]).children('td').eq(2).find('input[type="hidden"]').length >= 1 && $(rows[i]).attr("id") != "trNewTmp") {
                $(rows[i]).children('td').eq(0).children('#orderdiv').text(orders);
                orders++;
            }
        }
    }

    //保存事件
    //toList:是否跳转到列表页面；true=跳转到列表页面，false=停留在新增页面
    function SaveData(toList) {
        $(".button").hide();
        if (ValidateData()) {
            $("#IsToList").val(toList);
            $("form").submit();
        } else {
            $(".button").show();
        }
    }
    function ValidateNo(assemblyNo) {
        var NIVal = -1;
        $.ajax({
            dataType: "json",
            data: { assemblyNo: assemblyNo },
            cache: false,
            async: false,
            url: "/Assembly/ValidateNo/?" + Math.random(),
            type: "post",
            success: function (data) {
                NIVal = data.Data;
            },
            error: function () {
                Dialog.alert("失败");
            }
        });
        return NIVal;
    }
    function calAssemblyNo() {
        var assemblyNo = $("#AssemblyCode").val().trim();
        if (assemblyNo == "") {
            Dialog.alert("请输入单据编号");
            return;
        }
        if (!CheckWord(assemblyNo)) {
            return;
        }
        var temp = ValidateNo(assemblyNo);
        if (temp == "0") {
            Dialog.alert("单据编号重复");
            return;
        }
    }
    //数据验证
    function ValidateData() {
        //单据编号
        if ($("#AssemblyCode").val().trim() == "") {
            Dialog.alert("请输入单据编号。", function () {
                $("#AssemblyCode").addClass("input-validation-error");
            });
            return false;
        }
        if (!CheckWord($("#AssemblyCode").val().trim())) {
            $("#AssemblyCode").addClass("input-validation-error");
            return false;
        }
        if (ValidateNo($("#AssemblyCode").val()) == "0") {
            Dialog.alert("单据编号重复。", function () {
                $("#AssemblyCode").addClass("input-validation-error");
            });
            return false;
        }
        //验证经手人
        if ($("#AssemblyUserId").val() == '') {
            Dialog.alert("请选择经手人。", function () { $("#AssemblyUserId").addClass("input-validation-error"); });
            return false;
        }
        //验证业务日期
        if ($("#AssemblyDate").val() == '') {
            Dialog.alert("请选择业务日期。", function () { $("#AssemblyDate").addClass("input-validation-error"); });
            return false;
        }
        //验证无效的商品并提示
        if (!ValidateProduct()) {
            Dialog.alert("商品列表中存在无效的商品。");
            return false;
        }
        //验证是否选择了原商品
        if ($("#tabProducts tr").has("input[name$='ProductId'][value!='']").length < 1) {
            Dialog.alert("请选择原商品。", function () { $("#tabProducts").find("input:text[autocomplete='off']").first().focus(); });
            //$("#tabProducts").find("input:text[autocomplete='off']").first().focus();
            return false;
        }
        //验证是否选择了新商品
        if ($("#tabNewProducts tr").has("input[name$='ProductId'][value!='']").length < 1) {
            Dialog.alert("请选择新商品。", function () { $("#tabNewProducts").find("input:text[autocomplete='off']").first().focus(); });
            return false;
        }
        //验证数量
        if (!ValidateCount()) {
            Dialog.alert("商品数量必填并且大于0");
            return false;
        }
        //验证价格
        if (!ValidatePrice()) {
            Dialog.alert("商品数量必填并且大于0");
            return false;
        }
        return true;
    }
    //验证是否有无效的商品
    function ValidateProduct() {
        $("#tabProducts,#tabNewProducts").find("input:text[autocomplete='off']").removeClass("input-validation-error");
        var hasEmptyPro = true;
        var allCompleteTr = $("#tabProducts,#tabNewProducts").find("tr[empty!='']").has("input:text[autocomplete='off']");
        for (var i = 0; i < allCompleteTr.length; i++) {
            var curtr = $(allCompleteTr[i]);
            var pid = curtr.find("input:hidden[name$='ProductId']").first().val();
            var isEmptyPro = curtr.find("input:text[autocomplete='off'][value!='']").length > 0;
            if (pid == "" && isEmptyPro) {
                curtr.find("input:text[autocomplete='off']").addClass("input-validation-error");
                hasEmptyPro = false;
            };
        };
        return hasEmptyPro;
    }
    //验证数量
    function ValidateCount() {
        $("#tabProducts,#tabNewProducts").find("input[name$='Count']").removeClass("input-validation-error");
        var flag = true;
        $("#tabProducts,#tabNewProducts").find("tr[empty!='']").has("input[name$='ProductId'][value!='']").each(function () {
            var countObj = $(this).find("input[name$='Count']").first();
            var count = countObj.val();
            if (!isNumber(count) || count == '' || count <= 0 || count > 9999999999) {
                countObj.addClass("input-validation-error");
                flag = false;
            }
        });
        return flag;
    }
    //验证价格
    function ValidatePrice() {
        $("#tabProducts,#tabNewProducts").find("input[name$='Price']").removeClass("input-validation-error");
        var flag = true;
        $("#tabProducts,#tabNewProducts").find("tr[empty!='']").has("input[name$='ProductId'][value!='']").each(function () {
            var priceObj = $(this).find("input[name$='Price']").first();
            var price = priceObj.val();
            if (!isNumber(price) || price == '' || price < 0 || price > 9999999999) {
                priceObj.addClass("input-validation-error");
                flag = false;
            }
        });
        return flag;
    }

    //单行计算金额
    function calAmt(obj) {
        var $tr = $(obj).parent().parent();
        //验证单位
        var unitName = $tr.find("input[name='ShowUnitName']").val();
        var isDecimal = $tr.find("input[name$='IsDecimal']").val();


        var price = $tr.find("input[name$='Price']").val();
        var count = $tr.find("input[name$='Count']").val();
        //序列号
        var serialNo = $tr.find("input[name='hidSerialNo']").val();

        $tr.find("input[name$='Amount']").val((Number(price) * Number(count)).toFixed(2));

        //验证单位
        if (isDecimal == "0" && !isInteger(count)) {
            Dialog.alert('单位为 ' + unitName + ' 时， 数量必须输入整数！', function () {
                $tr.find("input[name$='Count']").val("");
                $tr.find("input[name$='Count']").focus();
                return;
            });
        }

        var serialNoArr = "";
        if (typeof (serialNo) != "undefined") {
            serialNoArr = serialNo.split(';')
        };
        if (Number(count) < (serialNoArr.length - 1)) {
            Dialog.alert("序列号个数不允许超过商品组装入库数量");
            $tr.find("input[name$='Count']").val("");
            $tr.find("input[name$='Count']").focus();

            return;
        }
        $tr.find("input[name$='Price']").val(Number(price).toFixed(2));
    } 

    //单行根据总金额和数量计算单价
    function calPrice(obj) { 
        var saleCount = $(obj).parent().parent().children('td').eq(4).find('input').val();
        var saleAmt = $(obj).parent().parent().children('td').eq(6).find('input').val();
        var salePrice = 0;
        if (saleCount != "" && Number(saleCount) != 0) {
            $(obj).parent().parent().children('td').eq(3).find('input').val((Number(saleAmt) / Number(saleCount)).toFixed(2));
            salePrice = Number(saleAmt) / Number(saleCount);
        }  
    }

    function openSn(obj) {
        var productId = $(obj).children('td').eq(2).find("input[name='NewProProductId']").val();
        var rowsId = $(obj).children('td').eq(2).find("input[name='hidRowId']").val();
        var warehouseId = $("#InWarehouseId").val();
        SingleSelectSerialNo(productId, rowsId, warehouseId, "Buy");
    }
    function SetWarehouseStock(obj) {
        var serialNoStr = $(obj).val();
        $(obj).val(serialNoStr.replace(",", ";"));
        var serialNo = $(obj).val().split(';');
        if ($(obj).parent().parent().children('td').eq(4).find("input[name='NewProCount']").attr("readonly") == "readonly") {
            $(obj).parent().parent().children('td').eq(4).find("input[name='NewProCount']").val(serialNo.length - 1).change();
        }
        else {
            var buyCount = $(obj).parent().parent().children('td').eq(4).find("input[name='NewProCount']").val();
            if ((serialNo.length - 1) > buyCount) {
                $(obj).parent().parent().children('td').eq(4).find("input[name='NewProCount']").val(serialNo.length - 1).change();
            }
        }
    }
</script>

                <div class="footer">
                    <div class="fl"><span class="fontOrange">客服热线：400-855-1002</span> 产品网站：<a href="http://www.joyinwise.com" class="font999" target="_blank">http://www.joyinwise.com</a><br />
                        智慧商贸 V2.9 版权所有: 安徽兆尹信息科技有限责任公司 Copyright © 2011-2014 All Rights Reserved</div>
                    <div class="fr">
                        <img src="../../Content/themes/default/images/qrhome.png" width="157" height="54" />
                    </div>
                </div>
            </td>
        </tr>
    </table>



    <script type="text/javascript">
        $(document).ready(function () {
            eval("");
            parent.$("#divLoading").hide();
            var errMsg = $(".validation-summary-errors").text();
            if (errMsg) {
                Dialog.alert(errMsg);
            }
        });

        function AjaxStart() {
            parent.$("#divLoading").show();
        }
        function AjaxStop() {
            parent.$("#divLoading").hide();
        }

    </script>
    <script type="text/javascript">
        function OpenQuickForm(vwidth, vheight, vpos, vsrc) {
            $("#divQuickForm iframe").css("width", vwidth);
            $("#divQuickForm iframe").css("height", vheight);
            $("#divQuickForm iframe").attr("src", vsrc);
            $("#divQuickForm").css("right", vpos);
            $("#divQuickForm").show();
        }

        function CloseQuickForm() {
            $("#divQuickForm").hide();
        }

        $(function () {
            $("li a").click(function () {
                if (typeof ($(this).find("span[name='navspan']").attr("class")) != "undefined") {
                    $("span[name='spanDt']").hide();
                    $("span[name='navspan']").attr("class", "plus");
                    $("#dt_" + $(this).attr("index")).show();
                    $(this).find("span[name='navspan']").attr("class", "short");
                }
            });
            //头部当前选中的ID
            var firstCurrentId = $(".menuRS").attr("index");
            //左边菜单当前选中的ID
            var currentId = $("li .nav2S a").attr("id");

            if (firstCurrentId) {
                //左边当前选中样式
                $("div.create_menu").hide();
                $("#secMenu_" + $("#" + firstCurrentId).attr("index")).show();
            }
            if (currentId) {
                //头部当前选中样式
                $(".menuRS").attr("class", "menuR");
                $("#firstRes_" + currentId.split('_')[1]).parent().attr("class", "menuRS");
                //左边当前选中菜单   
                $(".nav1S").attr("class", "nav1");
                $("#nav" + currentId.split('_')[2]).attr("class", "nav1S");

                //左边收起其他菜单 
                $("#dt_" + currentId.split('_')[2]).show();
                $("#dt_" + currentId.split('_')[2]).parent().find("span[name='navspan']").attr("class", "short");

                //当前位置
                //$("#curPos").html($("li .current").attr("pos"));
                var curObj = $("li .current");
                if (curObj.length == 2) {
                    $("#curPos").html($(curObj[1]).attr("pos"));
                } else {
                    $("#curPos").html($(curObj[0]).attr("pos"));
                }
            }
        });

        function exLeft() {
            if ($(".nav").is(":visible")) {
                $(".nav").hide();
                $(".navBg").attr("width", "10");
                $(".hiddenNav").attr("class", "hiddenNav2");
            }
            else {
                $(".nav").show();
                $(".navBg").attr("width", "225");
                $(".hiddenNav2").attr("class", "hiddenNav");
            }
        }

        function outLeft() {
            $(".nav").show();
            $(".navBg").attr("width", "225");
            $(".hiddenNav2").attr("class", "hiddenNav");
        }
    </script>
    <div style="display:none">
    <script type="text/javascript">
        var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
        //document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F21bfb059bc18ae42be9caea3a8b358ca' type='text/javascript'%3E%3C/script%3E"));
    </script></div>
</body>
</html>
<script type="text/javascript">
    var _controller = "Assembly";
    var _action = "Add";
    var _url = decodeURI("http://joyinwise.com/Assembly/Add");
    var _source = decodeURI("http://joyinwise.com/HomePage/Welcome");
    $.ajax({
        type: "GET",
        url: "/behavior/log?" + Math.random(),
        data: "control=" + _controller + "&action=" + _action + "&url=" + _url + "&source=" + _source
    });
</script>
