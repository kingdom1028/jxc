<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>智慧商贸
盘点单列表    </title>
    <script src="/Content/jquery-easyui/jquery-1.7.2.min.js?v2.9.5" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="/Content/themes/default/css/style.css?v2.9.5" />
    <link rel="stylesheet" type="text/css" href="/Content/jquery-easyui/themes/default/easyui.css?v2.9.5" />
    <link rel="stylesheet" type="text/css" href="/Content/jquery-easyui/themes/icon.css?v2.9.5" />
    <script src="/Scripts/jquery.validate-1.11.1.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/jquery.validate.unobtrusive.min.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/modernizr-1.7.min.js?v2.9.5" type="text/javascript"></script>
    <script src="/Content/My97DatePicker/WdatePicker.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/PropertyManager.js?v2.9.5" type="text/javascript"></script> 
    <script src="/Scripts/SelectProducts.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/GetState.js?v2.9.5" type="text/javascript"></script>
    <script src="/Content/jquery-easyui/jquery.easyui.min.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/PERM.js?2013?v2.9.5" type="text/javascript"></script>
    <script type="text/javascript" src="/Scripts/jquery.unobtrusive-ajax.min.js?v2.9.5"></script>
    <script src="/Scripts/MVCPage.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/jquery_validator_message_cn.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/PageLoading.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/ChinesePY.js?v2.9.5" type="text/javascript"></script> 
    <!--PNG透明-->
    <!--[if lte IE 6]>
    <script src="/Scripts/DD_belatedPNG_0.0.8a.js" type="text/javascript"></script>
        <script type="text/javascript">
            DD_belatedPNG.fix('*');
        </script>
    <![endif]-->
</head>
<body>
    <div id="loading"></div>
    <table style="min-width: 882px;" width="100%" border="0" height="610" cellspacing="0" cellpadding="0">
        <tr>
            <td valign="top" bgcolor="#e6e6e8" class="main">
                <script src="/Scripts/jquery.autocomplete.min.js" type="text/javascript"></script>

<form action="/StoreReserve/List" method="post"><input id="WriteBack" name="WriteBack" type="hidden" value="" />    <table width="100%" border="0" cellspacing="0" cellpadding="0" height="500">
        <tr>
            <td valign="top">
                <div class="buttonArea">
                    <div class="left">
                        <a class="button blueButton" onclick="addRecord()">新增盘点单</a>
                        <a id="aUnLock" class="button redButton" onclick="lockStatue()">盘点前锁定</a>
                        <a id="aLock" class="button greenButton" style="display: none;" onclick="lockStatue()">盘点后解锁</a>
                        <a class="tips">为什么要这么做？<div class="tipsPop"></div>
                        </a>
                    </div>
                    <!-- left -->
                    <div class="right">
                        <span class="fl">
                            <input type="checkbox" id="chkZF" value="0" onclick="reload()" checked="checked" style="margin-top:9px; float:left;"/>
                            <label for="chkZF" class="fl">&nbsp;不显示作废单据</label>&nbsp;&nbsp;&nbsp;&nbsp;</span>
                        <span id="simpleSearch">
                            <input class="inputText fl" id="SearchKey" name="SearchKey" placeholder="请输入模糊关键字" size="30" type="text" value="" />
                            <a class="button" onclick="reload()" id="search">搜索</a> </span>
                        <a class="button" id="aAdvanced">高级搜索</a>
                    </div>
                    <!-- right -->
                    <!-- searchAdvanced -->
                    <div class="searchAdvanced" style="padding: 5px 0; display: none;">
                        <input id="Advanced" name="Advanced" type="hidden" value="" />
                        <table width="98%" border="0" cellspacing="0" cellpadding="8">
                            <tr>
                                <td width="70" align="right">创建日期</td>
                                <td width="272"><input class="inputText date" id="SearchCreateStartDate" name="SearchCreateStartDate" onClick="WdatePicker({maxDate:&#39;#F{$dp.$D(\&#39;SearchCreateStartDate\&#39;) || \&#39;2100-10-01\&#39;}&#39;})" readonly="true" size="10" type="text" value="" />
                                    <span>&nbsp;&nbsp;~&nbsp;&nbsp;</span>
                                    <input class="inputText date" id="SearchCreateEndDate" name="SearchCreateEndDate" onClick="WdatePicker({minDate:&#39;#F{$dp.$D(\&#39;SearchCreateEndDate\&#39;)}&#39;,maxDate:&#39;2100-10-01&#39;})" readonly="true" size="10" type="text" value="" /></td>
                                <td width="70" align="right">经手人</td>
                                <td><input class="inputText wf100" id="SearchUser" name="SearchUser" type="text" value="" /></td>
                                <td width="70" align="right">制单人</td>
                                <td><input class="inputText wf100" id="SearchCreateUser" name="SearchCreateUser" type="text" value="" /></td>
                            </tr>
                            <tr>
                                <td width="70" align="right">业务日期</td>
                                <td><input class="inputText date" id="BillDateFrom" name="BillDateFrom" onClick="WdatePicker({maxDate:&#39;#F{$dp.$D(\&#39;BillDateTo\&#39;) || \&#39;2100-10-01\&#39;}&#39;})" readonly="true" size="10" type="text" value="" /> <span>&nbsp;&nbsp;~&nbsp;&nbsp;</span>
                                    <input class="inputText date" id="BillDateTo" name="BillDateTo" onClick="WdatePicker({minDate:&#39;#F{$dp.$D(\&#39;BillDateFrom\&#39;)}&#39;,maxDate:&#39;2100-10-01&#39;})" readonly="true" size="10" type="text" value="" /></td>
                                <td align="right"></td>
                                <td></td>
                                <td align="right"></td>
                                <td></td>
                            </tr>
                            <tr>
                                <td align="center" colspan="6"><a href="javascript:;" class=" button blueButton" onclick="reload()" id="searchAdvance">开始搜索</a></td>
                            </tr>
                        </table>
                    </div>
                    <!-- searchAdvanced -->
                </div>
                <!-- buttonArea -->

                <div class="clear height10"></div>
    <div class="shadowBoxWhite tableDiv">
        <input type="hidden" id="mvcUrl" />
        <div id="dvOrders">

            <table width="100%" border="0" cellspacing="1" cellpadding="5">
                <tr>
                    <th width="30" align="center">序号</th>
                    <th align="center" width="80">
                        <a data-ajax="true" data-ajax-mode="replace" data-ajax-update="#dvOrders" href="javascript:;" class="Ohead" id="SaleDate" onclick="Sort('SaleDate',this)">业务日期</a>
                    </th>
                    <th align="center" width="120">
                        <a data-ajax="true" data-ajax-mode="replace" data-ajax-update="#dvOrders" href="javascript:;" class="Ohead" id="SaleNo" onclick="Sort('SaleNo',this)">单据编号</a>
                    </th>
                    <th align="left">盘点商品范围</th> 
                    <th align="center" width="100">盘点仓库</th>
                    <th width="120" align="center">盘点状态</th> 
                    <th width="80" align="center">经手人</th>
                    <th align="center">备注</th>
                    <th width="120" align="center">操作</th>
                </tr>
              <tr>
                        <td align="center" valign="middle" bgcolor="#FFFFFF">
                            1
                        </td>
                        <td align="center" valign="middle" bgcolor="#FFFFFF">2014-02-15</td>
                        <td align="center" valign="middle" bgcolor="#FFFFFF">PD20140215005</td>
                        <td align="left" valign="middle" bgcolor="#FFFFFF">冰箱、连杆瓦</td> 
                  <td align="center" valign="middle" bgcolor="#FFFFFF">默认仓库</td>
                        <td align="center" valign="middle" bgcolor="#FFFFFF">尚未完成盘点</td> 
                        <td align="center" valign="middle" bgcolor="#FFFFFF">管理员</td>
                        <td align="center" valign="middle" bgcolor="#FFFFFF"></td> 
                        <td align="center" valign="middle" bgcolor="#FFFFFF">
                             <a class="operate edit PERM_EDIT" onclick="parent.childAddTab('盘点','/StoreReserve/Inventory/?TakBillId=33799ed4-1317-4f2e-93c1-32f17904e66d','慧管货')" title="开始盘点"></a>
                            <a class="operate del PERM_WB" onclick="writeBackRecord('33799ed4-1317-4f2e-93c1-32f17904e66d')" title="作废"></a>
                           
                        </td>
                    </tr> 
                <tr id="lastLine">
                    <td colspan="10" align="left" valign="middle" bgcolor="#FFFFFF">
                        
<!--MvcPager 1.5 for ASP.NET MVC 3.0 © 2009-2011 Webdiyer (http://www.webdiyer.com)-->

                    </td>
                </tr>
            </table>
        </div>
    </div>

<script type="text/javascript">
    $(document).ready(function () {
        //初始化排序图标
        var sortorder = request('sortorder', $("#mvcUrl").val());
        var usortname = request('sortname', $("#mvcUrl").val());
        if (usortname != '') {
            if (sortorder == 'asc') {
                $('#' + usortname).addClass("Oup");
            }
            else {
                $('#' + usortname).addClass("Odown");
            }
        }
            //默认排序
        else {
            $('#UpLoadTime').addClass("Odown");
        }
    });
</script>
                <!-- tableDiv -->
            </td>
        </tr>
    </table>
</form><script type="text/javascript">

    var retState = 1; 
    var tempName="";
    if(retState=="3")
    {
        $("#aLock").show();
        $("#aUnLock").hide();
        $(".tipsPop").html("盘点后解锁帐套，是为了开放销售、进货、收支、收付款等操作权限。");
    }
    else
    {
        $("#aLock").hide();
        $("#aUnLock").show();
        $(".tipsPop").html("盘点前锁定帐套是为了防止在盘点时进行销售或进货操作影响到库存，导致库存出错。");
        
    }
    $(document).ready(function () {
        var employeeheader = { EmployeeCode: "帐号", EmployeeName: "经手人" };
        $("#SearchUser").autoComplete({
            header: employeeheader,
            url: "/shared/queryemployee",
            width: 220,
            selected: function (o) {
                $("#SearchUser").val(o.EmployeeName);
            }
        });
        parent.CloseTabByTitle('盘点 ');
    });
    // 新增记录
    function addRecord() {  
        if(retState=="3")
        {     
            parent.childAddTab('库存盘点','/StoreReserve/Add','慧管货');
        }
        else
        {
            Dialog.alert("当前帐套未锁定，请先锁定帐套！");
        }
    }
    // 重新加载数据
    function reload() {
        MVCPage(getPageParams());
    } 
    function getPageParams() {
        var writeBack = "";
        if ($("#chkZF").attr("checked")) {
            writeBack = 0;
        }else{writeBack=1;}
        return [{ name: 'SearchKey', value: $("#SearchKey").val() },
                { name: 'SearchCreateStartDate', value: $("#SearchCreateStartDate").val() },
                { name: 'SearchCreateEndDate', value: $("#SearchCreateEndDate").val() },
                { name: 'SearchCreateUser', value: $("#SearchCreateUser").val() },
                { name: 'BillDateFrom', value: $("#BillDateFrom").val() },
                { name: 'BillDateTo', value: $("#BillDateTo").val() },
                { name: 'SearchUser', value: $("#SearchUser").val() },
                { name: 'Advanced', value: $("#Advanced").val() },
                { name: 'WriteBack', value: writeBack }
        ];
    }
    //获取帐套状态
    function getCurrentSOBState() {
        var retVar = "";
        $.ajax({
            url: "/StoreReserve/GetSOBState/",
            cache: false,
            type: "post",
            success: function (o) {               
                retVar = o;
            },
            error: function () {
                retVar = "error";
            }
        });
        return retVar;
    }
    function changeBtn()
    { 
        if(retState=="3")
        {
            //tempName='盘点后解锁';
            $("#aLock").show();
            $("#aUnLock").hide();
            $(".tipsPop").html("盘点后解锁帐套，是为了开放销售、进货、收支、收付款等操作权限。");
        }
        else
        {
            //tempName='盘点前锁定';  
            $("#aLock").hide();
            $("#aUnLock").show();
            $(".tipsPop").html("盘点前锁定帐套是为了防止在盘点时进行销售或进货操作影响到库存，导致库存出错。");
            
        }
        //$("#btn_taklock").text(tempName);
        //$("#fbtnLockText").text(tempName);
    }
    //盘点时锁定帐套状态
    function lockStatue() { 
        //去后台查询
        $.ajax({
            url: "/StoreReserve/GetSOBState/",            
            cache: false,
            type: "post",
            success: function (state) {
                if (state != "error") {
                    if (state=="3")
                    { //解锁
                        updateSOBState(1);        
                    }else{
                        parent.$.extend(parent.$.messager.defaults,{  
                            ok:"锁定",  
                            cancel:"取消"  
                        });
                        parent.$.messager.confirm('系统提示', '提示：确定要锁定帐套吗？', function (r) {
                            if(r)
                            {
                                if (state != "1") {
                                    Dialog.alert("当前帐套不为开帐状态！");
                                    return;
                                }else {//更新数据库与缓存
                                    updateSOBState(3);                
                                }
                            }
                        });  
                        parent.$.extend(parent.$.messager.defaults,{  
                            ok:"确定",  
                            cancel:"取消"  
                        });
                    }
                }
            },
            error: function () {
                Dialog.alert("获取失败！");
            }
        });
    }
    //更新数据库及缓存
    function updateSOBState(stateNum) {
        $.ajax({
            url: "/StoreReserve/UpdateSoBState/",
            data: {
                state: stateNum
            },
            cache: false,
            type: "post",
            success: function (o) {
                if (o == "success") {                  
                    if(stateNum==3)
                    {
                        Dialog.alert("已锁定帐套！");
                    
                    }
                    else if(stateNum == 1)
                    {
                        Dialog.alert("已解锁帐套！");
                    }
                    retState=stateNum;
                    changeBtn();                 
                }
            },
            error: function () {
                Dialog.alert("锁定失败！");
            }
        });
    }

    // 删除选中记录
    function deleteRecord(arg) {      
        var cids = arg;
        if (!cids) {
            Dialog.alert("至少选中一条记录！");
            return;
        }
        parent.$.messager.confirm('系统提示', "是否删除选中的数据", function (r) {    
            if(r){
                var temp=AddOrEditBySOBState('',true);  
                if(temp)
                {  
                    executeAjax("/StoreReserve/Delete/", cids, "删除盘点", "reload()"); 
                }     
            }
        });
    }

    // 盘点库存
    function editRecord() {   
    
        var temp=true;
        
        var cids = getSelectIds();
        var arrCode=new Array();
        if (!cids) {
            Dialog.alert("请选择一条记录！");
            return;
        }
        else if (cids.split(",").length > 1) {
            Dialog.alert("只能选择一条记录");
            return;
        }
        //判断作废，已作废数据只能查看，故不需要判断帐套状态， wtext=0说明未作废
        var wtext = $("#resultList").getSelect(0);
        var stext = $("#resultList").getSelect(5);
        if(wtext==0 || stext == '未盘点')
        {
            temp=AddOrEditBySOBState('',true);  
            if(!temp)
            {  
                return;
            }
        }
        arrCode=cids.split(',');
        var url= (stext == '未盘点' ? "Inventory" : "Inventoryed") + "?TakBillId="+arrCode[0];
        parent.childAddTab('盘点',url,'慧管货')
    }
    //调整库存
    function changeStore(arg)
    {
        temp=AddOrEditBySOBState('',true); 
        if(!temp){ return;}

        var temp=true;
        var cids = arg;
        parent.$.messager.confirm('系统提示', "是否调整当前盘点单中商品库存？", function (r) {
            if(r){
                $.ajax({
                    dataType:"json",
                    data:{billId:cids},
                    url:"/StoreReserve/UpdateToStore",
                    cache:false,
                    type:"post",
                    success: function(result){
                        if(result == "2"){
                            Dialog.alert("该盘点尚有未盘点的商品，请先完成盘点！");
                        }else if(result == "1"){
                            Dialog.alert("调整库存成功！");
                            location.reload();
                        }else{
                            Dialog.alert("调整库存失败，请重试！");
                        }
                    },
                    error: function()
                    {
                        Dialog.alert("调整库存失败，请重试！");
                    }
                });
            }
        });
    }
    function writeBackRecord(arg)
    {
        if(arg==null)
        {
            arg = getSelectIds();
        }
        var arrCode=new Array();
        if (!arg) {
            Dialog.alert("请选择一条记录！");
            return;
        }
        else if (arg.split(",").length > 1) {
            Dialog.alert("只能选择一条记录");
            return;
        }
        var temp=AddOrEditBySOBState('',true);  

        if(!temp)
        {  
            return;
        }
        parent.$.messager.confirm('系统提示', "确定要作废当前盘点单吗？", function (r) { 
            if(r)
            {
                executeAjax("/StoreReserve/WriteBack/", arg, "作废盘点单", "reload()");}
        }
       );
    }
    $(function () {
        //初始化查询方式
        var advanced = request("advanced");
        var writeBack = request("WriteBack");
        if (writeBack == "" || writeBack == "0") {
            $("#chkZF").attr("checked", true);
        }
        else {
            $("#chkZF").attr("checked", false);
        }
        if (advanced == "1") {
            $("#Advanced").val(1);
            $("#simpleSearch").hide();
            $(".searchAdvanced").show();
            //$("#aAdvanced").text("简单搜索");
            $("#aAdvanced").addClass("searchAdvancedS");
        } else {
            $("#Advanced").val(0);
            $("#simpleSearch").show();
            $(".searchAdvanced").hide();
            //$("#aAdvanced").text("高级搜索");
            $("#aAdvanced").removeClass("searchAdvancedS");
        }
        //高级查询按钮
        $("#aAdvanced").click(function () {
            if ($("#Advanced").val() == "0") {
                $("#Advanced").val(1);
                $("#simpleSearch").hide();
                //$("#aAdvanced").text("简单搜索")
                $("#aAdvanced").addClass("searchAdvancedS");
            } else {
                $("#Advanced").val(0);
                $("#simpleSearch").show();
                //$("#aAdvanced").text("高级搜索");
                $("#aAdvanced").removeClass("searchAdvancedS");
            }
            $(".searchAdvanced").slideToggle("slow");
        });

    })
    $(function () {
        $("#chkZF").click(function () { $("#WriteBack").val($(this).attr("checked") ? "0" : "1"); })
    });
</script>

                <div class="footer">
                    <div class="fl"><span class="fontOrange">客服热线：400-855-1002</span> 产品网站：<a href="http://www.joyinwise.com" class="font999" target="_blank">http://www.joyinwise.com</a><br />
                        智慧商贸 V2.9 版权所有: 安徽兆尹信息科技有限责任公司 Copyright © 2011-2014 All Rights Reserved</div>
                    <div class="fr">
                        <img src="../../Content/themes/default/images/qrhome.png" width="157" height="54" />
                    </div>
                </div>
            </td>
        </tr>
    </table>



    <script type="text/javascript">
        $(document).ready(function () {
            eval("");
            parent.$("#divLoading").hide();
            var errMsg = $(".validation-summary-errors").text();
            if (errMsg) {
                Dialog.alert(errMsg);
            }
        });

        function AjaxStart() {
            parent.$("#divLoading").show();
        }
        function AjaxStop() {
            parent.$("#divLoading").hide();
        }

    </script>
    <script type="text/javascript">
        function OpenQuickForm(vwidth, vheight, vpos, vsrc) {
            $("#divQuickForm iframe").css("width", vwidth);
            $("#divQuickForm iframe").css("height", vheight);
            $("#divQuickForm iframe").attr("src", vsrc);
            $("#divQuickForm").css("right", vpos);
            $("#divQuickForm").show();
        }

        function CloseQuickForm() {
            $("#divQuickForm").hide();
        }

        $(function () {
            $("li a").click(function () {
                if (typeof ($(this).find("span[name='navspan']").attr("class")) != "undefined") {
                    $("span[name='spanDt']").hide();
                    $("span[name='navspan']").attr("class", "plus");
                    $("#dt_" + $(this).attr("index")).show();
                    $(this).find("span[name='navspan']").attr("class", "short");
                }
            });
            //头部当前选中的ID
            var firstCurrentId = $(".menuRS").attr("index");
            //左边菜单当前选中的ID
            var currentId = $("li .nav2S a").attr("id");

            if (firstCurrentId) {
                //左边当前选中样式
                $("div.create_menu").hide();
                $("#secMenu_" + $("#" + firstCurrentId).attr("index")).show();
            }
            if (currentId) {
                //头部当前选中样式
                $(".menuRS").attr("class", "menuR");
                $("#firstRes_" + currentId.split('_')[1]).parent().attr("class", "menuRS");
                //左边当前选中菜单   
                $(".nav1S").attr("class", "nav1");
                $("#nav" + currentId.split('_')[2]).attr("class", "nav1S");

                //左边收起其他菜单 
                $("#dt_" + currentId.split('_')[2]).show();
                $("#dt_" + currentId.split('_')[2]).parent().find("span[name='navspan']").attr("class", "short");

                //当前位置
                //$("#curPos").html($("li .current").attr("pos"));
                var curObj = $("li .current");
                if (curObj.length == 2) {
                    $("#curPos").html($(curObj[1]).attr("pos"));
                } else {
                    $("#curPos").html($(curObj[0]).attr("pos"));
                }
            }
        });

        function exLeft() {
            if ($(".nav").is(":visible")) {
                $(".nav").hide();
                $(".navBg").attr("width", "10");
                $(".hiddenNav").attr("class", "hiddenNav2");
            }
            else {
                $(".nav").show();
                $(".navBg").attr("width", "225");
                $(".hiddenNav2").attr("class", "hiddenNav");
            }
        }

        function outLeft() {
            $(".nav").show();
            $(".navBg").attr("width", "225");
            $(".hiddenNav2").attr("class", "hiddenNav");
        }
    </script>
    <div style="display:none">
    <script type="text/javascript">
        var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
        //document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F21bfb059bc18ae42be9caea3a8b358ca' type='text/javascript'%3E%3C/script%3E"));
    </script></div>
</body>
</html>
<script type="text/javascript">
    var _controller = "StoreReserve";
    var _action = "List";
    var _url = decodeURI("http://joyinwise.com/StoreReserve/List");
    var _source = decodeURI("http://joyinwise.com/HomePage/Welcome");
    $.ajax({
        type: "GET",
        url: "/behavior/log?" + Math.random(),
        data: "control=" + _controller + "&action=" + _action + "&url=" + _url + "&source=" + _source
    });
</script>
