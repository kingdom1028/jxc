<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>智慧商贸
盘点库存    </title>
    <script src="/Content/jquery-easyui/jquery-1.7.2.min.js?v2.9.5" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="/Content/themes/default/css/style.css?v2.9.5" />
    <link rel="stylesheet" type="text/css" href="/Content/jquery-easyui/themes/default/easyui.css?v2.9.5" />
    <link rel="stylesheet" type="text/css" href="/Content/jquery-easyui/themes/icon.css?v2.9.5" />
    <script src="/Scripts/jquery.validate-1.11.1.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/jquery.validate.unobtrusive.min.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/modernizr-1.7.min.js?v2.9.5" type="text/javascript"></script>
    <script src="/Content/My97DatePicker/WdatePicker.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/PropertyManager.js?v2.9.5" type="text/javascript"></script> 
    <script src="/Scripts/SelectProducts.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/GetState.js?v2.9.5" type="text/javascript"></script>
    <script src="/Content/jquery-easyui/jquery.easyui.min.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/PERM.js?2013?v2.9.5" type="text/javascript"></script>
    <script type="text/javascript" src="/Scripts/jquery.unobtrusive-ajax.min.js?v2.9.5"></script>
    <script src="/Scripts/MVCPage.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/jquery_validator_message_cn.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/PageLoading.js?v2.9.5" type="text/javascript"></script>
    <script src="/Scripts/ChinesePY.js?v2.9.5" type="text/javascript"></script> 
    <!--PNG透明-->
    <!--[if lte IE 6]>
    <script src="/Scripts/DD_belatedPNG_0.0.8a.js" type="text/javascript"></script>
        <script type="text/javascript">
            DD_belatedPNG.fix('*');
        </script>
    <![endif]-->
</head>
<body>
    <div id="loading"></div>
    <table style="min-width: 882px;" width="100%" border="0" height="610" cellspacing="0" cellpadding="0">
        <tr>
            <td valign="top" bgcolor="#e6e6e8" class="main">
                <style type="text/css">
    .tipDiag {
        position: absolute;
        padding: 3px;
        font-size: 12px;
        border: 1px solid #C00;
        background: #FE8;
        color: #C00;
        display: none;
    }

    .hc, .hzfc {
        margin-top: 80px;
        width: 432px;
        height: 370px;
    }
</style>
<form action="/StoreReserve/EditRecords" method="post"><input id="TakBillNo" name="TakBillNo" type="hidden" value="PD20140215005" /><input data-val="true" data-val-number="字段 TakingStatus 必须是一个数字。" data-val-required="The TakingStatus field is required." id="TakingStatus" name="TakingStatus" type="hidden" value="0" /><input data-val="true" data-val-required="The ContactId field is required." id="ContactId" name="ContactId" type="hidden" value="932572a2-7dad-439c-b417-b67e60a33adb" /><input data-val="true" data-val-required="The SOBId field is required." id="SOBId" name="SOBId" type="hidden" value="6bc4be37-03ab-431c-a492-511376ad1d7b" /><input data-val="true" data-val-required="The CreateDate field is required." id="CreateDate" name="CreateDate" type="hidden" value="2014/2/15 12:25:26" /><input data-val="true" data-val-required="The CreateUserId field is required." id="CreateUserId" name="CreateUserId" type="hidden" value="18cb32bc-f5dd-4704-870b-26bbad60006e" /><input data-val="true" data-val-required="The TakBillId field is required." id="TakBillId" name="TakBillId" type="hidden" value="33799ed4-1317-4f2e-93c1-32f17904e66d" /><input data-val="true" data-val-required="The IsEdit field is required." id="IsEdit" name="IsEdit" type="hidden" value="False" />    <input id="oldBillRemark" type="hidden" value="" />
    <table width="100%" border="0" cellspacing="0" cellpadding="0" height="500">
        <tr>
            <td valign="top">
                <div class="buttonArea">
                    <div class="left"><a class="button blueButton" onclick="GoToList();">确定</a><a class="button" target="_blank" href="/HomePage/PrintReport?ReportGrf=StoreReserve.grf&DataUrl=/PrintReportData/PrintStoreReserve?Paras=33799ed4-1317-4f2e-93c1-32f17904e66d;2">打印</a> </div>
                    <!-- left -->
                    <div class="right"><a class="button greenButton" onclick="parent.childAddTab('历史盘点单','/StoreReserve/List','慧管货')">历史单据</a> </div>
                    <!-- right -->
                </div>
                <!-- buttonArea -->

                <div class="clear height10"></div>
                <div class="shadowBoxWhite receipts">
                    <table width="100%" border="0" cellspacing="0" cellpadding="5" class="title">
                        <tr>
                            <td width="30%" height="50">&nbsp;</td>
                            <td width="40%" align="center" valign="top" class="text">库存盘点单</td>
                            <td width="30%" align="right" valign="bottom" class="font999" style="padding-bottom: 20px;">单据编号：PD20140215005</td>
                        </tr>
                    </table>
                    <div class="baseData">
                        <div class="fl">
                            <div class="tab_pd">
                                <ul>
                                    <li class="tab_pdN"><a href="/StoreReserve/Inventory?TakBillId=33799ed4-1317-4f2e-93c1-32f17904e66d">未盘点商品 (<span id="spUnChecked">2</span>)</a></li>
                                    <li class="tab_pdS"><a href="/StoreReserve/Inventoryed?TakBillId=33799ed4-1317-4f2e-93c1-32f17904e66d">已盘点商品 (<span id="spChecked">0</span>)</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="fr">
                            <div class="fl">
                                <span>盘点仓库：默认仓库</span>
                                &nbsp;&nbsp;
                                <span>经手人：管理员</span>
                                &nbsp;&nbsp;
                                <span>业务日期：2014-02-15</span>
                            </div>
                        </div>
                    </div>
                    <div class="clear height10"></div>
                    <div class="tableDiv">
                        <table width="100%" border="0" cellspacing="1" cellpadding="5">
                            <tr>
                                <th width="60" height="60" align="center" valign="middle">序号</th>
                                <th align="center" width="120" valign="middle">商品编号</th>
                                <th align="left" valign="middle">商品名称/规格</th>
                                <th width="60" align="center" valign="middle">单位</th>
                                <th width="70" align="center" valign="middle">账面数量</th>
                                <th width="70" align="center" valign="middle">实际数量</th>
                                
                                <th width="100" align="left" valign="middle">备注</th>
                                <th width="100" align="center" valign="middle">操作</th>
                            </tr>
                        </table>
                    </div>
                    <!-- tableDiv -->
                    <div class="bottomButtonArea">
                        <div class="left font999">制单人：管理员 &nbsp;&nbsp;&nbsp;&nbsp;制单时间：2014-02-15 12:25:26</div>
                        <div class="right"><a class="button blueButton" onclick="GoToList();">确定</a><a class="button" target="_blank" href="/HomePage/PrintReport?ReportGrf=StoreReserve.grf&DataUrl=/PrintReportData/PrintStoreReserve?Paras=33799ed4-1317-4f2e-93c1-32f17904e66d;2">打印</a> </div>
                    </div>
                    <!-- buttonArea -->
                </div>
                <!-- receipts -->
            </td>
        </tr>
    </table>
</form><script type="text/javascript">
    function CheckError(takId, productId, warehouseId, snManage,isDecimal) {
        var serial = "0";
        if (serial=="1"&&snManage == "1") {
            PDSerialNo("33799ed4-1317-4f2e-93c1-32f17904e66d", takId, productId, warehouseId, null, "2");
        }
        else {
            var td = $("#p_" + takId + " td.last");
            td.children().hide();
            td.find("div[name='editText']").show();
            if (snManage == "2") {
                //td.find("input[name='t_" + takId + "']").val(Number($("#SysCount_" + takId).val()).toFixed(2));
                td.find("div[name='editText']").css("width","70px");
                td.find("div[name='editSn']").css("display", "inline-block");
            }
        }
    }
    function editStock(obj, takId, productId, warehouseId, snManage, isDecimal) {
        var serial = "0";
        var val = $(obj).val();
        if (val == "") {
            var td = $("#p_" + takId + " td.last");
            td.children().hide();
            td.find("a[name='aCheck']").show();
            td.find("a[name='aEdit']").show();
        } else {
            if (isNaN(Number(val))) {
                Dialog.alert("请输入数值");
                $(obj).addClass("error").focus();
            }
            else if (isDecimal == "0" && !isInteger(val)) {
                Dialog.alert("该商品盘点数量必须为整数");
                $(obj).addClass("error").focus();
            }
            else {
                var temp = true;
                if (serial == "1" && snManage == "2") {
                    var allowCount = GetProductSnCount(productId, warehouseId, takId);
                    if (allowCount > Number(val)) {
                        temp = false;
                        PDSerialNo("33799ed4-1317-4f2e-93c1-32f17904e66d", takId, productId, warehouseId, Number(val), "2");
                    }
                }
                if (temp) {
                    var remark = $("#Remark_" + takId).val();
                    CheckItem(takId, val, remark);

                }
            }
        }
    }
    //盘点单ID, 商品ID, 系统库存量, 实际库存量, 备注
    function CheckItem(takId, realCount, remark, productId, warehouseId, productSNManage) {
        var snManage = $("#snManage_" + takId).val();
        var oldrealCount = $("#rc_" + takId).text();
        var tStore = $("#t_" + takId).val();
        if (snManage == "2") {
            if (oldrealCount > realCount && tStore == "") {
                realCount = oldrealCount;
            }
            if (tStore != "") {
                realCount = tStore;
            }
        }
        $.ajax({
            type: "POST",
            url: "/StoreReserve/CheckProduct/",
            data: { "TakId": takId, "RealCount": realCount, "Remark": remark },
            success: function (data) {
                if (data == 1) {
                    $("#p_" + takId).children('td').eq(5).text(realCount);
                    var td = $("#p_" + takId + " td.last");
                    td.children().hide();
                    td.find("a[name='aCheck']").show();
                    td.find("a[name='aEdit']").show();
                } else {
                    Dialog.alert("盘点库存失败，请重试！");
                }
            },
            error: function () {
                Dialog.alert("盘点库存失败，请重试！");
            }
        });
        JudgeStoreReservice(1);
    }
    //获取当前商品库存数
    function GetProductSnCount(productId, warehouseId,takId) {
        var count = 0;
        $.ajax({
            dataType: "json",
            data: { productId: productId, warehouseId: warehouseId,takId:takId },
            cache: false,
            async: false,
            url: "/HomePage/GetProductSerialNoCountPD/?" + Math.random(),
            type: "post",
            success: function (data) {
                count = data.Data;
            },
            error: function () {
                count = 0;
            }
        });
        return count;
    }
    function GoToList() {
        JudgeStoreReservice();
    }
    function JudgeStoreReservice() {
        var takBillId = $("#TakBillId").val();
        $.ajax({
            dataType: "json",
            data: { takId: takBillId },
            url: "/StoreReserve/CheckTakOver",
            cache: false,
            type: "post",
            success: function (result) {
                if (result == "1") {
                    parent.$.messager.confirm('系统提示', '所有商品盘点完成，是否现在调整库存？', function (r) {
                        if (r) {
                            changeStore(takBillId);
                        }
                    });
                }
            },
            error: function () {
                Dialog.alert("system error！");
            }
        });

    }
    //调整库存
    function changeStore(arg) {
        temp = AddOrEditBySOBState('', true);
        if (!temp) { return; }

        var temp = true;
        var cids = arg;
        $.ajax({
            dataType: "json",
            data: { billId: cids },
            url: "/StoreReserve/UpdateToStore",
            cache: false,
            type: "post",
            success: function (result) {
                if (result == "2") {
                    Dialog.alert("该盘点尚有未盘点的商品，请先完成盘点！");
                } else if (result == "1") {
                    Dialog.alert("调整库存成功！");
                    parent.childAddTab('历史盘点单', '/StoreReserve/List', '慧管货');
                } else {
                    Dialog.alert("调整库存失败，请重试！");
                }
            },
            error: function () {
                Dialog.alert("调整库存失败，请重试！");
            }
        });
    }
</script>

                <div class="footer">
                    <div class="fl"><span class="fontOrange">客服热线：400-855-1002</span> 产品网站：<a href="http://www.joyinwise.com" class="font999" target="_blank">http://www.joyinwise.com</a><br />
                        智慧商贸 V2.9 版权所有: 安徽兆尹信息科技有限责任公司 Copyright © 2011-2014 All Rights Reserved</div>
                    <div class="fr">
                        <img src="../../Content/themes/default/images/qrhome.png" width="157" height="54" />
                    </div>
                </div>
            </td>
        </tr>
    </table>



    <script type="text/javascript">
        $(document).ready(function () {
            eval("");
            parent.$("#divLoading").hide();
            var errMsg = $(".validation-summary-errors").text();
            if (errMsg) {
                Dialog.alert(errMsg);
            }
        });

        function AjaxStart() {
            parent.$("#divLoading").show();
        }
        function AjaxStop() {
            parent.$("#divLoading").hide();
        }

    </script>
    <script type="text/javascript">
        function OpenQuickForm(vwidth, vheight, vpos, vsrc) {
            $("#divQuickForm iframe").css("width", vwidth);
            $("#divQuickForm iframe").css("height", vheight);
            $("#divQuickForm iframe").attr("src", vsrc);
            $("#divQuickForm").css("right", vpos);
            $("#divQuickForm").show();
        }

        function CloseQuickForm() {
            $("#divQuickForm").hide();
        }

        $(function () {
            $("li a").click(function () {
                if (typeof ($(this).find("span[name='navspan']").attr("class")) != "undefined") {
                    $("span[name='spanDt']").hide();
                    $("span[name='navspan']").attr("class", "plus");
                    $("#dt_" + $(this).attr("index")).show();
                    $(this).find("span[name='navspan']").attr("class", "short");
                }
            });
            //头部当前选中的ID
            var firstCurrentId = $(".menuRS").attr("index");
            //左边菜单当前选中的ID
            var currentId = $("li .nav2S a").attr("id");

            if (firstCurrentId) {
                //左边当前选中样式
                $("div.create_menu").hide();
                $("#secMenu_" + $("#" + firstCurrentId).attr("index")).show();
            }
            if (currentId) {
                //头部当前选中样式
                $(".menuRS").attr("class", "menuR");
                $("#firstRes_" + currentId.split('_')[1]).parent().attr("class", "menuRS");
                //左边当前选中菜单   
                $(".nav1S").attr("class", "nav1");
                $("#nav" + currentId.split('_')[2]).attr("class", "nav1S");

                //左边收起其他菜单 
                $("#dt_" + currentId.split('_')[2]).show();
                $("#dt_" + currentId.split('_')[2]).parent().find("span[name='navspan']").attr("class", "short");

                //当前位置
                //$("#curPos").html($("li .current").attr("pos"));
                var curObj = $("li .current");
                if (curObj.length == 2) {
                    $("#curPos").html($(curObj[1]).attr("pos"));
                } else {
                    $("#curPos").html($(curObj[0]).attr("pos"));
                }
            }
        });

        function exLeft() {
            if ($(".nav").is(":visible")) {
                $(".nav").hide();
                $(".navBg").attr("width", "10");
                $(".hiddenNav").attr("class", "hiddenNav2");
            }
            else {
                $(".nav").show();
                $(".navBg").attr("width", "225");
                $(".hiddenNav2").attr("class", "hiddenNav");
            }
        }

        function outLeft() {
            $(".nav").show();
            $(".navBg").attr("width", "225");
            $(".hiddenNav2").attr("class", "hiddenNav");
        }
    </script>
    <div style="display:none">
    <script type="text/javascript">
        var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
        //document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F21bfb059bc18ae42be9caea3a8b358ca' type='text/javascript'%3E%3C/script%3E"));
    </script></div>
</body>
</html>
<script type="text/javascript">
    var _controller = "StoreReserve";
    var _action = "Inventoryed";
    var _url = decodeURI("http://joyinwise.com/StoreReserve/Inventoryed?TakBillId=33799ed4-1317-4f2e-93c1-32f17904e66d");
    var _source = decodeURI("http://joyinwise.com/StoreReserve/Inventory/?TakBillId=33799ed4-1317-4f2e-93c1-32f17904e66d");
    $.ajax({
        type: "GET",
        url: "/behavior/log?" + Math.random(),
        data: "control=" + _controller + "&action=" + _action + "&url=" + _url + "&source=" + _source
    });
</script>
